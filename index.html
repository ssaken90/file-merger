<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Объединитель файлов</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #drop-area {
            border: 2px dashed #ccc;
            border-radius: 20px;
            width: 100%;
            padding: 20px;
            text-align: center;
        }
        #drop-area.highlight {
            border-color: purple;
        }
        #file-list {
            margin-top: 20px;
        }
        .file-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .file-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .file-item .delete-icon {
            margin-left: 10px;
            cursor: pointer;
            color: red;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
        }
        .extension-inputs, .preset-controls {
            margin-top: 20px;
        }
        .extension-inputs input, .preset-controls input, .preset-controls select {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Объединитель файлов</h1>
    <div class="extension-inputs">
        <label for="includeExtensions">Включить расширения (через запятую):</label>
        <input type="text" id="includeExtensions" placeholder="Например: txt, js, css">
        <label for="excludeExtensions">Исключить расширения (через запятую):</label>
        <input type="text" id="excludeExtensions" placeholder="Например: pdf, doc, xls">
    </div>
    <div class="preset-controls">
        <input type="text" id="presetName" placeholder="Название пресета">
        <button id="savePresetBtn">Сохранить пресет</button>
        <select id="presetSelect">
            <option value="">Выберите пресет</option>
        </select>
        <button id="loadPresetBtn">Загрузить пресет</button>
        <button id="deletePresetBtn">Удалить пресет</button>
    </div>
    <div id="drop-area">
        <p>Перетащите файлы или папки сюда или нажмите для выбора</p>
        <input type="file" id="fileInput" multiple webkitdirectory hidden>
    </div>
    <div id="file-list"></div>
    <button id="combineButton">Объединить файлы</button>
    <button id="clearButton">Очистить список</button>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('file-list');
        const combineButton = document.getElementById('combineButton');
        const clearButton = document.getElementById('clearButton');
        const includeExtensionsInput = document.getElementById('includeExtensions');
        const excludeExtensionsInput = document.getElementById('excludeExtensions');
        const presetNameInput = document.getElementById('presetName');
        const savePresetBtn = document.getElementById('savePresetBtn');
        const presetSelect = document.getElementById('presetSelect');
        const loadPresetBtn = document.getElementById('loadPresetBtn');
        const deletePresetBtn = document.getElementById('deletePresetBtn');
        let files = [];

        // Загрузка пресетов при инициализации
        loadPresets();

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('highlight');
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
        }

        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);
        dropArea.addEventListener('click', () => fileInput.click());
        clearButton.addEventListener('click', clearFileList);
        savePresetBtn.addEventListener('click', savePreset);
        loadPresetBtn.addEventListener('click', loadPreset);
        deletePresetBtn.addEventListener('click', deletePreset);

        function getExtensionFilters() {
            const includeExtensions = includeExtensionsInput.value
                .split(',')
                .map(ext => ext.trim().toLowerCase())
                .filter(ext => ext);
            const excludeExtensions = excludeExtensionsInput.value
                .split(',')
                .map(ext => ext.trim().toLowerCase())
                .filter(ext => ext);
            return { includeExtensions, excludeExtensions };
        }

        function shouldIncludeFile(fileName) {
            const { includeExtensions, excludeExtensions } = getExtensionFilters();
            const fileExtension = fileName.split('.').pop().toLowerCase();

            if (excludeExtensions.includes(fileExtension)) {
                return false;
            }

            if (includeExtensions.length > 0) {
                return includeExtensions.includes(fileExtension);
            }

            return true;
        }

        async function handleDrop(e) {
            const items = e.dataTransfer.items;
            for (const item of items) {
                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry();
                    if (entry) {
                        await traverseFileTree(entry);
                    }
                }
            }
            updateFileList();
        }

        async function handleFiles(e) {
            const selectedFiles = e.target.files;
            for (const file of selectedFiles) {
                const relativePath = file.webkitRelativePath || file.name;
                if (file.size <= 1024 * 1024 && shouldIncludeFile(file.name)) {
                    files.push({ file, path: relativePath, selected: true });
                }
            }
            updateFileList();
        }

        async function traverseFileTree(item, path = '') {
            if (item.isFile) {
                const file = await new Promise((resolve) => item.file(resolve));
                if (file.size <= 1024 * 1024 && shouldIncludeFile(file.name)) {
                    const fullPath = path + file.name;
                    files.push({ file, path: fullPath, selected: true });
                }
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                const entries = await new Promise((resolve) => {
                    dirReader.readEntries(resolve);
                });
                for (const entry of entries) {
                    await traverseFileTree(entry, path + item.name + '/');
                }
            }
        }

        function updateFileList() {
            fileList.innerHTML = '';
            files.forEach((fileObj, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = fileObj.selected;
                checkbox.addEventListener('change', () => {
                    files[index].selected = checkbox.checked;
                });

                const fileNameSpan = document.createElement('span');
                fileNameSpan.textContent = fileObj.path;

                const deleteIcon = document.createElement('span');
                deleteIcon.textContent = '❌';
                deleteIcon.className = 'delete-icon';
                deleteIcon.addEventListener('click', () => {
                    files.splice(index, 1);
                    updateFileList();
                });

                fileItem.appendChild(checkbox);
                fileItem.appendChild(fileNameSpan);
                fileItem.appendChild(deleteIcon);
                fileList.appendChild(fileItem);
            });
        }

        function clearFileList() {
            files = [];
            updateFileList();
        }

        function savePreset() {
            const presetName = presetNameInput.value.trim();
            if (!presetName) {
                alert('Пожалуйста, введите название пресета');
                return;
            }

            const preset = {
                includeExtensions: includeExtensionsInput.value,
                excludeExtensions: excludeExtensionsInput.value
            };

            let presets = JSON.parse(localStorage.getItem('filePresets')) || {};
            presets[presetName] = preset;
            localStorage.setItem('filePresets', JSON.stringify(presets));

            loadPresets(); // Обновляем список пресетов
            alert('Пресет сохранен');
        }

        function loadPreset() {
            const selectedPreset = presetSelect.value;
            if (!selectedPreset) {
                alert('Пожалуйста, выберите пресет');
                return;
            }

            const presets = JSON.parse(localStorage.getItem('filePresets')) || {};
            const preset = presets[selectedPreset];

            if (preset) {
                includeExtensionsInput.value = preset.includeExtensions;
                excludeExtensionsInput.value = preset.excludeExtensions;
                alert('Пресет загружен');
            }
        }

        function deletePreset() {
            const selectedPreset = presetSelect.value;
            if (!selectedPreset) {
                alert('Пожалуйста, выберите пресет для удаления');
                return;
            }

            let presets = JSON.parse(localStorage.getItem('filePresets')) || {};
            delete presets[selectedPreset];
            localStorage.setItem('filePresets', JSON.stringify(presets));

            loadPresets(); // Обновляем список пресетов
            alert('Пресет удален');
        }

        function loadPresets() {
            const presets = JSON.parse(localStorage.getItem('filePresets')) || {};
            presetSelect.innerHTML = '<option value="">Выберите пресет</option>';
            
            for (const presetName in presets) {
                const option = document.createElement('option');
                option.value = presetName;
                option.textContent = presetName;
                presetSelect.appendChild(option);
            }
        }

        combineButton.addEventListener('click', combineFiles);

        async function combineFiles() {
            const selectedFiles = files.filter(f => f.selected);
            if (selectedFiles.length === 0) {
                alert('Пожалуйста, выберите файлы для объединения.');
                return;
            }

            let combinedContent = '';
            let fileNames = [];

            for (const { file, path } of selectedFiles) {
                const content = await readFile(file);
                combinedContent += `${path};\n${content}\n\n\n`;
                fileNames.push(file.name.split('.').slice(0, -1).join('.'));
            }

            const outputFileName = generateOutputFileName(fileNames);
            downloadCombinedFile(combinedContent, outputFileName);
        }

        function generateOutputFileName(fileNames) {
            const baseName = 'combined_files';
            const namesList = fileNames.join('_');
            let fullName = `${baseName}_${namesList}`;
            
            if (fullName.length > 200) {
                fullName = fullName.substring(0, 196) + '...';
            }
            
            return fullName + '.txt';
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        function downloadCombinedFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>